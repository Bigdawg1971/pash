var sessionKey=null,clientConfiguration=null,powerShellPrompt=null,secureStringHolder="<*secure string*>",lastExecutedMessage=null,executionHandle=false,promptForChoiceHandle=false,promptReadLineHandle=false,securePromptHandle=false,promptForCredentialHandle=false,timeoutHandle=false,countdownHandle=false,sessionTimeout=null,countdownTimeout=null,countdown=null,sessionExpired=false,loggingOut=false,cancelling=false,promptShortCuts={},promptHelp=[],commandStack=[],commandStackPos=-1,commandBufferSize=50,lastAnswer=0,promptAnswers=[],promptHandle=-1,previousLineCount=1,lineHeight=15,paddingExcess=2,scrollBarSize=12,sidePaddding=5,lastWidthChecked=null,statusHeight=5,minKeepVisible=5,running=false,resizeHandler=false,promptReplied=false,handlingHistory=false,addedTemporalCommand=false,tabCompletions=null,tabCompletionsIndex=0,tabCompletionRequest=null,currentState=null,totalConsoleRows=null,isCompositeKey=false,lastResizeAt=1,promptMessage=null,setPromptReplyMessage=null,pages={error:"./error.aspx",logout:"./logout.aspx",logon:"./logon.aspx",timeout:"./timeout.aspx"},resources={timeoutMessage:L_TimeOut_HTMLText,executing:L_Executing_Text,provideUsername:L_ProvideUsername_Text,providePassword:L_ProvidePassword_Text,invalidChoice:L_InvalidChoice_Text,choicesHelpMessage:L_ChoicesHelpMessage_Text,targetUnreachable:L_TargetUnreachable_Text},keys={backspace:8,tab:9,enter:13,shift:16,ctrl:17,option:18,alt:18,pause:19,capslock:20,esc:27,pgup:33,pgdown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,supr:46,q:81,v:86,cmd:91,contextmenu:92,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145},messagesQueue=[],shell={console:function(){return this._console||(this._console=S("#console"))},input:function(){return this._input||(this._input=S("#console textarea"))},password:function(){return this._password||(this._password=S("#console input.secure"))},output:function(){return this._output||(this._output=S("#output"))},status:function(){return this._status||(this._status=S("#console div.status-bar"))},error:function(){return this._error||(this._error=S("#console pre.error"))},footer:function(){return this._footer||(this._footer=S("#console div.footer"))},submit:function(){return this._submit||(this._submit=S("li.play input"))},stop:function(){return this._stop||(this._stop=S("li.stop input"))},tab:function(){return this._tab||(this._tab=S("li.tab button"))},historyUp:function(){return this._historyUp||(this._historyUp=S("li.history.up button"))},disableHistoryUp:function(c){this.historyUp().disable(c);var b=this._historyUpEnabledIcon||(this._historyUpEnabledIcon=S("#historyUpEnabledIcon")),a=this._historyUpDisabledIcon||(this._historyUpDisabledIcon=S("#historyUpDisabledIcon"));if(c){b.hide();a.show()}else{b.show();a.hide()}},historyDown:function(){return this._historyDown||(this._historyDown=S("li.history.down button"))},disableHistoryDown:function(c){this.historyDown().disable(c);var b=this._historyDownEnabledIcon||(this._historyDownEnabledIcon=S("#historyDownEnabledIcon")),a=this._historyDownDisabledIcon||(this._historyDownDisabledIcon=S("#historyDownDisabledIcon"));if(c){b.hide();a.show()}else{b.show();a.hide()}},logout:function(){return this._logout||(this._logout=S("li.logout input"))},free:function(){return this._free||(this._free=S("#free"))},run:function(b){var a=this.input().val();S("div.output pre.placeholder").remove();shell.write(powerShellPrompt);if(!a){shell.write(" ",clientConfiguration.InputForegroundColor,clientConfiguration.InputBackgroundColor).ready();return}shell.write(a,clientConfiguration.InputForegroundColor,clientConfiguration.InputBackgroundColor);if(addedTemporalCommand){commandStack.pop();addedTemporalCommand=false}addHistory(this.input(),commandBufferSize);shell.block(true);b(a);return this},target:function(a){var b=S("#console li.machine-name strong");a&&b.text(a);return this},initializeOutput:function(a){this._free=S("<div id='free' class='free' style='background-color: "+clientConfiguration.BackgroundColor+"'></div>");this.output().html("").append(this._free);if(a){this.write(L_PowershellFullName_Text);this.write(L_Copyright_Text);this.write("");powerShellPrompt&&this.write(powerShellPrompt,null,null,"placeholder")}autoResize();return this},clear:function(){this.initializeOutput(false);return this},write:function(e,o,n,l){if(typeof e=="string")e=[e];for(var a=shell.output().children().last(),i=a&&a.hasClass(ClientMessageType_Write)&&a.get(0)&&a.get(0).innerText?a.get(0).innerText.length:0,k=o||clientConfiguration.ForegroundColor,j=n||clientConfiguration.BackgroundColor,g=$browser.msie?"\r\n":"",f=0,h=0;h<e.length;h++)for(var m=e[h].replace(/\r/g,"").buffer(clientConfiguration.BufferSize.Width-1,i),c=m.split("\n"),d=0;d<c.length;d++){var b=null;if(f<1&&a.hasClass(ClientMessageType_Write)){b=a;var p=S("<span style='color:"+k+"; background-color:"+j+"'>"+(c[d].replace("\n","").htmlEncode()||" ")+(d<c.length-1?"":g)+"</span>");b.removeClass(ClientMessageType_Write).addClass(ClientMessageType_WriteLine).append(p);f++}else{b=S("<pre class='"+ClientMessageType_WriteLine+"' style='color:"+k+"; background-color:"+j+"'>"+((c[d].replace("\n","").htmlEncode()||" ")+(d<c.length-1?"":g))+"</pre>");shell.output().append(b)}a=b;i=0;!b.text()&&$browser.msie&&b.html("&nbsp;"+g);l&&b.addClass(l)}this.output().adjustBuffer(c.length+1-f);this.output().get(0).scrollTop=this.output().get(0).scrollHeight;autoResize();return this},prompt:function(){shell.input().show().addClass("prompt");shell.tab().disable(true);this.block(false);autoResize();return this},promptHandler:function(a){promptMessage=a;promptMessage.custom={};promptMessage.custom.reply=[];promptMessage.custom.credentialBuffer=null;promptMessage.custom.listBuffer=null;promptMessage.custom.prompting=false;a.Caption&&shell.write(a.Caption);a.Message&&shell.write(a.Message);promptHandle=window.setInterval(shell.handlerPrompt,100)},handlerPrompt:function(){if(cancelling){CancelPromptTimer(promptHandle);return}if(promptMessage.custom.prompting&&promptAnswers.length==0)return;if(promptMessage.custom.reply.length>=promptMessage.Descriptions.length){setPromptReplyMessage=function(){PageMethods._staticInstance.SetPromptReply(sessionKey,promptMessage.custom.reply,OnGetClientMessagesSuccess,StartRecovery,null)};setPromptReplyMessage();promptMessage=null;window.clearInterval(promptHandle);return}var a=promptMessage.Descriptions[promptMessage.custom.reply.length];if(!promptMessage.custom.prompting){promptMessage.custom.prompting=true;var d=null;if(!a.PromptFieldTypeIsList)d=a.Name+": ";else{if(!promptMessage.custom.listBuffer)promptMessage.custom.listBuffer=[];d=a.Name+"["+promptMessage.custom.listBuffer.length+"]: "}switch(a.PromptFieldType){case PromptFieldType_String:shell.inline(d,null,null);shell.prompt();break;case PromptFieldType_SecureString:shell.inline(d,null,null);shell.secure();break;case PromptFieldType_Credential:if(!promptMessage.custom.credentialBuffer){promptMessage.custom.credentialBuffer={};shell.write(d,null,null,false)}if(!promptMessage.custom.credentialBuffer.username){shell.inline(resources.provideUsername,null,null);shell.prompt()}else shell.inline(resources.providePassword,null,null).secure();break;default:redirectTo(pages.error,true)}}else{promptMessage.custom.prompting=false;var b=promptAnswers.pop(),c=null,e=false;switch(a.PromptFieldType){case PromptFieldType_String:case PromptFieldType_SecureString:if(b==""&&a.PromptFieldTypeIsList)e=true;else c=b;break;case PromptFieldType_Credential:if(b==""){if(a.PromptFieldTypeIsList&&!promptMessage.custom.credentialBuffer.username)e=true}else if(!promptMessage.custom.credentialBuffer.username)promptMessage.custom.credentialBuffer.username=b;else{promptMessage.custom.credentialBuffer.password=b;c=promptMessage.custom.credentialBuffer;promptMessage.custom.credentialBuffer=null}break;default:redirectTo(pages.error,true)}if(e){promptMessage.custom.reply.push(promptMessage.custom.listBuffer);promptMessage.custom.listBuffer=null}else if(c)if(a.PromptFieldTypeIsList)promptMessage.custom.listBuffer.push(c);else promptMessage.custom.reply.push(c)}shell.output().attr({scrollTop:shell.output().attr("scrollHeight")})},promptForCredentialHandler:function(a){promptMessage=a;promptMessage.custom={};promptMessage.custom.username="";promptMessage.custom.password="";promptMessage.custom.prompting=false;a.Caption&&shell.write(a.Caption);a.Message&&shell.write(a.Message);promptForCredentialHandle=window.setInterval(shell.handlerPromptForCredential,100)},handlerPromptForCredential:function(){if(cancelling){CancelPromptTimer(promptForCredentialHandle);return}if(promptMessage.custom.prompting&&promptAnswers.length==0)return;if(promptMessage.custom.username&&promptMessage.custom.password){setPromptReplyMessage=function(){PageMethods._staticInstance.SetPromptForCredentialReply(sessionKey,promptMessage.custom.username,promptMessage.custom.password,OnGetClientMessagesSuccess,StartRecovery,null)};setPromptReplyMessage();promptMessage=null;window.clearInterval(promptForCredentialHandle);return}if(!promptMessage.custom.prompting){promptMessage.custom.prompting=true;if(!promptMessage.custom.username){shell.inline(resources.provideUsername,null,null);var a=promptMessage.UserName!==undefined?promptMessage.UserName.trim():null;if(a){shell.write(a,clientConfiguration.InputForegroundColor);promptMessage.custom.username=a}else shell.prompt()}promptMessage.custom.username&&shell.inline(resources.providePassword,null,null).secure()}else{promptMessage.custom.prompting=false;var b=promptAnswers.pop();if(b!="")if(!promptMessage.custom.username)promptMessage.custom.username=b;else promptMessage.custom.password=b}shell.output().attr({scrollTop:shell.output().attr("scrollHeight")})},handlerPromptForChoices:function(){if(cancelling)CancelPromptTimer(promptForChoiceHandle);else if(promptAnswers.length==0&&!shell.input().hasClass("prompt")){shell.prompt();shell.output().attr({scrollTop:shell.output().attr("scrollHeight")})}else if(promptAnswers.length==1){var a=promptAnswers[0].toUpperCase(),c=promptShortCuts[a]>=0?promptShortCuts[a]:a==""?promptMessage.DefaultChoice:-1;if(promptAnswers[0].match(/^\s*\?\s*$/)){for(var b=0;b<promptHelp.length;b++)shell.write(promptHelp[b]);showPromptOptions(promptMessage)}else if(c==-1){shell.write(resources.invalidChoice);showPromptOptions(promptMessage)}else{setPromptReplyMessage=function(){PageMethods._staticInstance.SetPromptForChoiceReply(sessionKey,c,OnGetClientMessagesSuccess,StartRecovery,null)};setPromptReplyMessage();promptShortCuts={};promptHelp=[];window.clearInterval(promptForChoiceHandle)}promptAnswers=[]}},secure:function(){shell.input().hide();shell.password().show().focus();shell.tab().disable(true);this.block(false);shell.disableHistoryUp(true);shell.disableHistoryDown(true);return this},inline:function(k,l,j){var a=shell.output().children().last(),i=l||clientConfiguration.ForegroundColor,g=j||clientConfiguration.BackgroundColor,m=$browser.msie?"\r\n":"",f=1;if(a.size()==0||a.get(0).tagName.match(/pre/i)&&!a.hasClass(ClientMessageType_Write)){a=S("<pre style='background-color:"+clientConfiguration.BackgroundColor+"' class='inline "+ClientMessageType_Write+"' />");f=0}for(var e=a&&a.hasClass(ClientMessageType_Write)&&a.get(0)&&a.get(0).innerText?a.get(0).innerText.length:0,h=k.replace(/\r/g,"").buffer(clientConfiguration.BufferSize.Width-1,e),c=h.split("\n"),b=0;b<c.length;b++){var d=" ";if(c.length>1&&b<c.length-1)d=(c[b].replace("\n","").htmlEncode()||" ")+m;else if(c[b])d=c[b].htmlEncode();(b>0&&d.length==clientConfiguration.BufferSize.Width||b==0&&d.length+e==clientConfiguration.BufferSize.Width-1)&&a.removeClass(ClientMessageType_Write).addClass(ClientMessageType_WriteLine);var n=S("<span style='color:"+i+";background-color:"+g+"' >"+d+"</span>");a.append(n);shell.output().append(a);a=S("<pre style='background-color:"+clientConfiguration.BackgroundColor+"' class='inline "+ClientMessageType_Write+"' />")}this.output().adjustBuffer(c.length-f);this.output().get(0).scrollTop=this.output().get(0).scrollHeight;autoResize();return this},read:function(){var a=this.input().val();this.write(a,clientConfiguration.InputForegroundColor,clientConfiguration.InputBackgroundColor).block(true).input().removeClass("prompt");promptAnswers.push(a);return this},readLine:function(){var a=this.input().val();this.write(a,clientConfiguration.InputForegroundColor,clientConfiguration.InputBackgroundColor).block(true).input().removeClass("prompt").removeClass("readline");promptAnswers.push(a);return this},readSecure:function(){var a=this.password().val();this.password().val("").hide();this.write(secureStringHolder.replace(/./g,"*"),clientConfiguration.InputForegroundColor,clientConfiguration.InputBackgroundColor);this.block(true).input().show();promptAnswers.push(a.split(""));return this},block:function(a){!this.input().hasClass("prompt")&&!this.password().isVisible()&&this.stop().disable(!a);this.submit().disable(a);this.password().val("");this.input().disable(a).val("").addClass("executing");this.logout().disable(a);if(a){shell.executing();shell.tab().disable(true);shell.disableHistoryUp(true);shell.disableHistoryDown(true)}else{if(commandStack.length>0){commandStackPos=commandStack.length;shell.disableHistoryUp(false);shell.disableHistoryDown(true)}window.clearInterval(executionHandle);this.input().removeClass("executing")}if(!mobile()&&!a)this.input().focus();else this.input().blur();return this},executing:function(){executionHandle=window.setInterval(increaseProgress,500);return this},ready:function(){this.output().children().last().hasClass(ClientMessageType_Write)&&this.write("");this.write(powerShellPrompt,null,null,"placeholder");this.password().hide();this.error().hide();this.input().removeClass("executing").removeClass("prompt").removeClass("ready").show().focus();shell.tab().disable(false);shell.status().hide();window.clearInterval(executionHandle);window.clearInterval(promptHandle);window.clearInterval(promptForChoiceHandle);window.clearInterval(promptReadLineHandle);window.clearInterval(securePromptHandle);window.clearInterval(promptForCredentialHandle);promptShortCuts={};promptHelp=[];promptAnswers=[];lastAnswer=0;shell.writeProgress("","","","",0);this.block(false);resetTimeout(false);this.output().get(0).scrollTop=this.output().get(0).scrollHeight;autoResize()},adjustFormFactor:function(){var b=S("#console");if(!b.isVisible()){currentState=+new Date;b.show();shell.input().focus()}if(currentState!=state()||lastWidthChecked!=shell.input().width()){shell.input().attr("cols",clientConfiguration.WindowSize.Width-1);shell.output().height(totalConsoleRows*lineHeight-shell.input().height()+paddingExcess);var a=shell.input().width();shell.password().width(a);shell.output().width(a+2*sidePaddding);shell.error().width(a);shell.footer().width(a);shell.status().width(a);S("#progress").width(clientConfiguration.WindowSize.Width*2);S("#percentComplete").css("marginLeft",clientConfiguration.WindowSize.Width-10+"px");S("#timeBar").css("marginLeft",clientConfiguration.WindowSize.Width-5+"px");b.width(a+scrollBarSize).css("margin","0 auto");lastWidthChecked=a;shell.output().get(0).scrollTop=shell.output().get(0).scrollHeight;currentState=state()}autoResize()},configure:function(a){a.target&&shell.target(a.target);if(a.title)document.title=a.title;if(a.windowSize){totalConsoleRows=a.windowSize.Height+1;this.input().attr("cols",a.windowSize.Width-1);currentState=+new Date;clientConfiguration.WindowSize=a.windowSize;lastResizeAt=-1}if(a.bufferSize){clientConfiguration.BufferSize.Height=a.bufferSize.Height;clientConfiguration.BufferSize.Width=a.bufferSize.Width;currentState=+new Date}if(a.backgroundColor){clientConfiguration.BackgroundColor=a.backgroundColor;shell.status().css("backgroundColor",clientConfiguration.BackgroundColor)}if(a.foregroundColor){clientConfiguration.ForegroundColor=a.foregroundColor;shell.status().css("color",clientConfiguration.ForegroundColor)}if(a.defaultOptionForegroundColor)clientConfiguration.DefaultOptionForegroundColor=a.defaultOptionForegroundColor;if(a.inputForegroundColor){shell.input().css("color",a.inputForegroundColor);shell.password().css("backgroundColor",a.inputBackgroundColor)}if(a.inputBackgroundColor){shell.input().css("backgroundColor",a.inputBackgroundColor);shell.password().css("backgroundColor",a.inputBackgroundColor)}if(a.sessionTimeout){sessionTimeout=a.sessionTimeout;resetTimeout()}if(a.timeoutCountdown){countdownTimeout=a.timeoutCountdown;resetTimeout()}return this},setup:function(a,b){this.initializeOutput(true);this.output().keydown(handleOutputPanelKeys);this.input().keydown(handleInputPanelKeys).focus(function(){S(this).addClass("focus")}).blur(function(){S(this).removeClass("focus")}).removeAttr("disabled").val("");this.password().keydown(handleInputPanelKeys).focus(function(){S(this).addClass("focus")}).blur(function(){S(this).removeClass("focus")}).val("");this.footer().keydown(handleFooterPanelKeys);window.setInterval(shell.adjustFormFactor,50);this.stop().click(function(){if(S(this).attr("disabled"))return;S(this).disable(true);b()});this.submit().click(function(){if(S(this).attr("disabled"))return;var b=shell.input().isVisible()?shell.input():shell.password();handleEnter(b,a)});this.tab().click(function(){if(S(this).attr("disabled"))return;if(shell.input().isVisible()&&shell.input().hasClass("prompt"))return;if(shell.password().isVisible()&&shell.password().hasClass("secure"))return;handleTab(shell.input(),false)});this.historyUp().click(function(){return S(this).attr("disabled")?void 0:setHistoryLocation(shell.input(),commandStackPos-1)});this.historyDown().click(function(){return S(this).attr("disabled")?void 0:setHistoryLocation(shell.input(),commandStackPos+1)});this.logout().click(function(){if(S(this).attr("disabled"))return false;loggingOut=true;redirectTo(pages.logout,false);return false});return this},countdown:function(){countdown-=1e3;setTimeoutMessage();countdown==0&&resetTimeout(true);return this},writeProgress:function(h,l,j,g,i){for(var e=S("#console div.status-bar pre"),a=0;a<e.size();a++)if(a==0)S(e[a]).text("");else S(e[a]).remove();S("#console div.status-bar div.bar").width(i+"%");S("#console div.status-bar div.percentage span").text(i+"%");if(h){S("#console div.status-bar div.time").show();S("#console div.status-bar div.time span").text(h)}else S("#console div.status-bar div.time").hide();var f=l;if(j)f+=" - "+j;if(g)f+=" - "+g;for(var c=S("#console div.status-bar pre"),k=f.replace(/\r/g,"").buffer(clientConfiguration.WindowSize.Width-1),b=k.split("\n"),m=$browser.msie?"\r\n":"",a=0;a<b.length;a++){var d=" ";if(b.length>1&&a<b.length-1)d=(b[a].replace("\n","").htmlEncode()||" ")+m;else if(b[a])d=b[a].htmlEncode();var n=S("<span>"+d+"</span>");c.append(n);if(b.length>1&&!$browser.msie){c.addClass(ClientMessageType_WriteLine);if(d.length==clientConfiguration.WindowSize.Width-1){c=S("<pre />");this.status().append(c)}}}this.output().get(0).scrollTop=this.output().get(0).scrollHeight;autoResize();return this},targetUnreachable:function(){shell.input().hide();shell.block(true);shell.stop().disable(true);shell.logout().disable(false);shell.footer().css("border-top-width","0px");shell.error().text(resources.targetUnreachable).show().css("overflow","hidden");return this},timeout:function(){setTimeoutMessage();countdownHandle=window.setInterval(shell.countdown,1e3);var a=S("#timeout");shell.input().disable(true);shell.stop().disable(true);shell.submit().disable(true);a.show().css({"margin-top":-((a.height()+10)/2)+"px","margin-left":-((a.width()+10)/2)+"px"});S("body").append('<div id="overlay" style="display:none;"></div>');S("#overlay").show();S("#timeoutkeepalive").focus();var b=function(){PageMethods._staticInstance.ResetSessionTimeout(sessionKey,function(){},StartRecovery);S("#overlay").hide();S("#timeout").hide();resetTimeout(sessionExpired);shell.input().disable(false).focus();shell.submit().disable(false);return false};S("#timeout input.keep-alive").click(b);S("#timeout input.logout").click(function(){redirectTo(pages.logout,true);return false});return this}};function mobile(){return iPhone()||windowsPhone()||iPad()||android()}function iPhone(){return navigator.userAgent.match(/iPhone;/i)}function iPad(){return navigator.userAgent.match(/iPad;/i)}function windowsPhone(){return navigator.userAgent.match(/Windows\sPhone\sOS\s7.\d;/i)}function android(){return navigator.userAgent.match(/Android\s\d(\.\d)+;/i)}function verticalOriented(){return iPhone()?window.orientation==0:windowsPhone()?S(window).width()==320:false}function setTimeoutMessage(){var a=Math.floor(countdown/6e4),b=Math.floor(countdown/1e3%60);S("#timeout p.countdown").html(resources.timeoutMessage.replace(/\{0\}/,a).replace(/\{1\}/,b))}function resetTimeout(a){sessionExpired=a;if(sessionExpired)redirectTo(pages.timeout,false);else{window.clearTimeout(timeoutHandle);window.clearInterval(countdownHandle);if(countdownTimeout>0&&sessionTimeout-countdownTimeout>0)timeoutHandle=window.setTimeout(shell.timeout,sessionTimeout-countdownTimeout);countdown=countdownTimeout}}function clearCurrentTimeout(){window.clearTimeout(timeoutHandle);window.clearInterval(countdownHandle)}function redirectTo(b,a){window.onbeforeunload=null;window.onunload.terminateSession=a;window.location.href=b}function autoResize(){var c=shell.input().isVisible(),e=shell.status().isVisible(),f=shell.error().isVisible(),g=shell.password().isVisible(),a=c?shell.input().lineCountWindowSizeWidth():e?statusHeight:shell.error().lineCount(),i=totalConsoleRows-minKeepVisible-(e?statusHeight:0),p=c||g||f?-1:0,m=totalConsoleRows*lineHeight+p;if(a>i)a=i;shell.status().height(statusHeight*lineHeight);shell.input().height(a*lineHeight);shell.error().height(shell.error().lineCount()*lineHeight);var o=c||g||f?-1:1,l=e?statusHeight*lineHeight-o:0,d=0;if(c)d=shell.input().height()-2;else if(g)d=shell.password().height()-2;else if(f)d=shell.error().height()-2;shell.output().height(m-d-l);var b=totalConsoleRows-a-shell.output().writtenLines();if(e)b-=statusHeight;if(!c&&!g&&!f)b+=a;if(b>=0&&lastResizeAt!=b){shell.output().adjustBuffer(shell.free().children().size());for(var j="",h=0;h<b;h++)j+="<br/>";shell.free().html(j);lastResizeAt=b}for(var q=shell.output().writtenLines()-clientConfiguration.BufferSize.Height,h=0;h<q;h++)shell.output().children().first().remove();var k=shell.output().get(0).scrollTop,n=shell.output().get(0).scrollHeight;if(n-k!=shell.output().outerHeight()&&previousLineCount!=a)shell.output().get(0).scrollTop=k+lineHeight*(a-previousLineCount);previousLineCount=a;return false}function increaseProgress(){if(shell.input().val().match(resources.executing))shell.input().val(shell.input().val().replace(/\.\.\.$/,"")+".");else shell.input().val(resources.executing);!shell.historyUp().attr("disabled")&&shell.historyUp().disable(true);!shell.historyDown().attr("disabled")&&shell.historyDown().disable(true)}function toggleProgress(a){shell.status().toggle(!a);shell.input().toggle(a);!mobile()&&a&&shell.input().focus();autoResize()}function handleOutputPanelKeys(a){if(!a)a=window.event;if(!handleGlobalKeys(a))return false;if(a.keyCode==keys.enter&&!a.altKey&&!a.ctrlKey&&!a.shiftKey&&!a.metaKey&&!shell.input().hasClass("focus")){shell.submit().click();return false}if(a.keyCode==a.shiftKey||a.keyCode==a.crtlKey||a.keyCode==keys.ctrl||a.keyCode==keys.shift||a.keyCode==keys.capslock||a.keyCode==keys.cmd||a.keyCode==224||a.keyCode==229){isCompositeKey=true;return true}if(a.keyCode==keys.left||a.keyCode==keys.right||a.keyCode==keys.up||a.keyCode==keys.down||a.keyCode==keys.home||a.keyCode==keys.end||a.keyCode==keys.pgup||a.keyCode==keys.pgdown||a.keyCode==keys.insert||a.keyCode==keys.supr||a.keyCode>=112&a.keyCode<=123||a.keyCode==keys.option)return;if(isCompositeKey){isCompositeKey=false;if(a.keyCode!=keys.v)return}if(!mobile()&&!shell.input().hasClass("focus")){shell.input().focus().setCursorPosition(shell.input().val().length);return true}}function handleInputPanelKeys(a){if(!a)a=window.event;if(!handleGlobalKeys(a))return false;if(S(this).attr("disabled"))return;if(a.shiftKey&&!a.altKey&&!a.ctrlKey&&!a.metaKey&&a.keyCode==keys.enter&&S(this).val().trim().length<1){a.returnValue=false;return false}var b=a.keyCode==keys.enter&&(!a.shiftKey&&!a.altKey&&!a.ctrlKey&&!a.metaKey||S(this).hasClass("secure"));if(b){if(addedTemporalCommand){commandStack.pop();addedTemporalCommand=false}if(!$browser.msie8)shell.output().focus();else shell.submit().focus();shell.submit().click();a.returnValue=false;if(S(this).hasClass("prompt")||S(this).hasClass("secure"))return false}if(a.keyCode==keys.tab&&!S(this).hasClass("prompt")&&!S(this).hasClass("secure"))return handleTab(S(this),a.shiftKey);else!a.shiftKey&&a.keyCode!=keys.shift&&resetTabCompletion();if(a.keyCode==keys.esc){S(this).val(null);if(addedTemporalCommand){commandStack.pop();addedTemporalCommand=false}commandStackPos=commandStack.length;setHistoryButtonStatus()}else if(a.keyCode==keys.up&&(!S(this).val().trim()||handlingHistory)&&!S(this).hasClass("secure"))return setHistoryLocation(S(this),commandStackPos-1);else if(a.keyCode==keys.down)if(handlingHistory&&!S(this).hasClass("secure")){if(commandStackPos<commandStack.length)return setHistoryLocation(S(this),commandStackPos+1)}else{var c=false,d=S(this).getCursorPosition(),e=S(this).val().indexOf("\n",d);c=e==-1;S(this).val()&&c&&S(this).val().charCodeAt(S(this).val().length-1)!=10&&S(this).val(S(this).val()+"\n");S(this).attr({scrollTop:S(this).attr("scrollHeight")})}else if(a.keyCode==keys.pgup&&(!S(this).val().trim()||handlingHistory)&&!S(this).hasClass("secure"))return setHistoryLocation(S(this),0);else if(a.keyCode==keys.pgdown&&(!S(this).val().trim()||handlingHistory)&&!S(this).hasClass("secure"))return setHistoryLocation(S(this),commandStack.length-1);else if(!(a.keyCode==keys.esc||a.keyCode==keys.left||a.keyCode==keys.right||a.keyCode==keys.shift||a.keyCode==keys.ctrl||a.keyCode==keys.alt||a.keyCode==keys.capslock||a.keyCode==keys.f1||a.keyCode==keys.f2||a.keyCode==keys.f3||a.keyCode==keys.f4||a.keyCode==keys.f5||a.keyCode==keys.f6||a.keyCode==keys.f7||a.keyCode==keys.f8||a.keyCode==keys.f9||a.keyCode==keys.f10||a.keyCode==keys.f11||a.keyCode==keys.f12||a.keyCode==keys.cmd||a.keyCode==keys.contextmenu||a.keyCode==keys.insert||a.keyCode==keys.numlock||a.keyCode==keys.scrolllock||a.keyCode==keys.f1||a.keyCode==keys.home||a.keyCode==keys.end||a.keyCode==keys.pause))if(handlingHistory){handlingHistory=false;if(addedTemporalCommand){commandStack.pop();addedTemporalCommand=false}commandStackPos=commandStack.length;setHistoryButtonStatus()}if(b)return false}function handleFooterPanelKeys(a){if(!a)a=window.event;return!handleGlobalKeys(a)?false:true}function handleGlobalKeys(a){if(!a)a=window.event;if(a.ctrlKey&&!a.shiftKey&&!a.altKey&&!a.metaKey&&a.keyCode==L_CancelCommand_Accelerator_KeyCode){shell.stop().click();return false}return true}function handleEnter(a,b){if(a.attr("disabled"))return false;if(a.hasClass("prompt")&&a.hasClass("readline"))shell.readLine();else if(a.hasClass("prompt"))shell.read();else if(a.hasClass("secure"))shell.readSecure();else return shell.run(b);addHistory(a,commandBufferSize)}function setHistoryButtonStatus(){if(commandStackPos<=0)shell.disableHistoryUp(true);else shell.disableHistoryUp(false);if(commandStackPos>=commandStack.length-1)shell.disableHistoryDown(true);else shell.disableHistoryDown(false)}function handleTab(a,c){var b=a.val();if(b==""||tabCompletionRequest!=null)return true;if(tabCompletions==null)tabCompletionRequest=PageMethods._staticInstance.GetTabCompletion(sessionKey,b,onTabCompletionSuceeded,onTabCompletionError,{input:a,reverse:c});else completeCurrentCommand(a,c);return false}function onTabCompletionSuceeded(b,a){tabCompletionRequest=null;if(b.Status!=PowwaStatus_Success){onTabCompletionError();return}tabCompletions=b.Value;tabCompletionsIndex=a.reverse?tabCompletions.length:-1;completeCurrentCommand(a.input,a.reverse)}function onTabCompletionError(){tabCompletionRequest=null;resetTabCompletion()}function resetTabCompletion(){if(tabCompletionRequest!=null){var a=tabCompletionRequest.get_executor();a.get_started()&&a.abort()}tabCompletions=null;tabCompletionsIndex=0}function completeCurrentCommand(a,b){if(tabCompletions.length==0)return;if(b)tabCompletionsIndex=tabCompletionsIndex==0?tabCompletions.length-1:tabCompletionsIndex-1;else tabCompletionsIndex=tabCompletionsIndex==tabCompletions.length-1?0:tabCompletionsIndex+1;a.val(tabCompletions[tabCompletionsIndex]);!mobile()&&a.focus().setCursorPosition(a.val().length)}function addHistory(c,b){var a=c.val().trim();if(a.length==0)return;commandStack.length==b&&commandStack.shift();commandStack[commandStack.length-1]!=a&&commandStack.push(a);if(commandStackPos>=0)commandStackPos++;commandStack.length>0&&shell.disableHistoryUp(false);shell.disableHistoryDown(true)}function setHistoryLocation(b,a){if(commandStack.length==0)return false;if(a<0)a=0;else if(a>=commandStack.length)a=commandStack.length-1;var c=b.val().trim();if(!handlingHistory&&c.length>0){addedTemporalCommand&&commandStack.pop();addedTemporalCommand=true;addHistory(shell.input())}handlingHistory=true;commandStackPos=a;b.val(commandStack[commandStackPos]);!mobile()&&b.setCursorPosition(b.val().length).focus();setHistoryButtonStatus();return false}function showPromptOptions(a){for(var d=0,c=0;c<a.Choices.length;c++){if(!a.Choices[c])continue;var g=a.Choices[c].Label,i=g.shortcut(),h=g.replace("&",""),b=h+"  ";b="["+(i||"")+"] "+b;if(d+b.length>clientConfiguration.BufferSize.Width-1){shell.write("");d=0}d+=b.length;shell.inline(b,c==a.DefaultChoice?clientConfiguration.DefaultOptionForegroundColor:clientConfiguration.ForegroundColor,null)}var e=a.Choices[a.DefaultChoice||0]||{Label:"(null)"},f=resources.choicesHelpMessage.replace("{0}",e.Label.shortcut()||e.Label);d+f.length>clientConfiguration.BufferSize.Width-1&&shell.write("");shell.inline(f)}function OnGetClientMessagesSuccess(a,b,d){switch(a.Status){case PowwaStatus_Success:if(a.Value)if(a.Value.length>0)for(var c=0;c<a.Value.length;c++)messagesQueue.push(a.Value[c]);else if(b)if(b.Status===PowwaSessionStatus_Prompting)messagesQueue.push(b.PromptMessage);else b.Status===PowwaSessionStatus_Available&&messagesQueue.push({MessageType:ClientMessageType_CommandCompleted,Prompt:powerShellPrompt});break;case PowwaStatus_ValidationError:shell.write(a.Message);if(lastExecutedMessage){if(lastExecutedMessage.MessageType==ClientMessageType_PromptForCredential)lastExecutedMessage.UserName="";messagesQueue.push(lastExecutedMessage)}break;case PowwaStatus_InvalidSession:redirectTo(pages.timeout,false);break;default:redirectTo(pages.error,false)}resetTimeout(false);d!="CancelCommand"&&ProcessMessages()}function StartRecovery(e,d,b){shell.write(L_NetworkError_RecoveryStarted_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);var c=new Date,a={methodName:b,failTime:(new Date).setTime(c.getTime()+24e4),progressTimer:window.setInterval(function(){shell.write(L_NetworkError_RecoveryProgress_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor)},1e4),submitEnabled:!shell.submit().attr("disabled"),cancelEnabled:!shell.stop().attr("disabled"),tabCompletedEnabled:!shell.tab().attr("disabled"),historyUpEnabled:!shell.historyUp().attr("disabled"),historyDownEnabled:!shell.historyDown().attr("disabled"),signoutEnabled:!shell.logout().attr("disabled")};!a.submitEnabled||shell.submit().disable(true);!a.cancelEnabled||shell.stop().disable(true);!a.tabCompletedEnabled||shell.tab().disable(true);!a.historyUpEnabled||shell.disableHistoryUp(true);!a.historyDownEnabled||shell.disableHistoryDown(true);!a.signoutEnabled||shell.logout().disable(true);resetTimeout(false);PageMethods._staticInstance.GetSessionStatus(sessionKey,DoRecovery,RetryRecovery,a)}function RetryRecovery(c,a,b){if(new Date>a.failTime)FailRecovery(c,a,b);else window.setTimeout(function(){PageMethods._staticInstance.GetSessionStatus(sessionKey,DoRecovery,RetryRecovery,a)},8e3)}function DoRecovery(a,b){window.clearInterval(b.progressTimer);if(a.Status!==PowwaStatus_Success){if(a.Status===PowwaStatus_InvalidSession)redirectTo(pages.timeout,false);else redirectTo(pages.error,false);return}b.submitEnabled&&shell.submit().disable(false);b.cancelEnabled&&shell.stop().disable(false);b.tabCompletedEnabled&&shell.tab().disable(false);b.historyUpEnabled&&shell.disableHistoryUp(false);b.historyDownEnabled&&shell.disableHistoryDown(false);b.signoutEnabled&&shell.logout().disable(false);shell.write(L_NetworkError_RecoverySucceeded_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);shell.write("",clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);switch(b.methodName){case"CancelCommand":switch(a.Value.Status){case PowwaSessionStatus_Executing:case PowwaSessionStatus_Prompting:PageMethods._staticInstance.CancelCommand(sessionKey,OnGetClientMessagesSuccess,StartRecovery,a.Value)}break;case"ExecuteCommand":shell.write(L_NetworkError_RecoveryWarning_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);if(a.Value.Status===PowwaSessionStatus_Available)shell.write(L_NetworkError_RecoveryWarning_CommandLoss_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);else shell.write(L_NetworkError_RecoveryWarning_OutputLoss_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);PageMethods._staticInstance.GetClientMessages(sessionKey,OnGetClientMessagesSuccess,StartRecovery,a.Value);break;case"GetClientMessages":shell.write(L_NetworkError_RecoveryWarning_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);shell.write(L_NetworkError_RecoveryWarning_OutputLoss_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);PageMethods._staticInstance.GetClientMessages(sessionKey,OnGetClientMessagesSuccess,StartRecovery,a.Value);break;case"ResetSessionTimeout":break;case"SetPromptReply":case"SetPromptForChoiceReply":case"SetPromptForCredentialReply":case"SetReadLineReply":case"SetReadLineAsSecureStringReply":if(a.Value.Status===PowwaSessionStatus_Prompting&&a.Value.PromptMessage.Id===promptMessage.Id)setPromptReplyMessage();else{shell.write(L_NetworkError_RecoveryWarning_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);shell.write(L_NetworkError_RecoveryWarning_OutputLoss_Text,clientConfiguration.WarningForegroundColor,clientConfiguration.WarningBackgroundColor);PageMethods._staticInstance.GetClientMessages(sessionKey,OnGetClientMessagesSuccess,StartRecovery,a.Value)}break;default:redirectTo(pages.error,false)}}function FailRecovery(c,a){window.clearInterval(a.progressTimer);shell.write(L_NetworkError_RecoveryFailed_Text,clientConfiguration.ErrorForegroundColor,clientConfiguration.ErrorBackgroundColor);shell.write("",clientConfiguration.ErrorForegroundColor,clientConfiguration.ErrorBackgroundColor);shell.input().hide()}function ProcessMessages(){var d=true;if(messagesQueue.length>0){var a=messagesQueue.shift(),b=false,c=false;switch(a.MessageType){case ClientMessageType_Prompt:shell.promptHandler(a);b=true;break;case ClientMessageType_PromptForCredential:shell.promptForCredentialHandler(a);b=true;break;case ClientMessageType_PromptForChoice:ProcessPromptForChoiceMessage(a);b=true;break;case ClientMessageType_ReadLine:ProcessReadLineMessage(a);b=true;break;case ClientMessageType_ReadLineAsSecureString:ProcessReadLineAsSecureStringMessage(a);b=true;break;case ClientMessageType_Write:ProcessWriteMessage(a);break;case ClientMessageType_WriteLine:ProcessWriteLineMessage(a);break;case ClientMessageType_WriteProgress:ProcessWriteProgressMessage(a);break;case ClientMessageType_ClearBuffer:shell.clear();break;case ClientMessageType_SetBufferSize:shell.configure({bufferSize:a.Size});break;case ClientMessageType_SetWindowTitle:shell.configure({title:a.Title});break;case ClientMessageType_SetWindowSize:shell.configure({windowSize:a.Size});break;case ClientMessageType_SetForegroundColor:shell.configure({foregroundColor:a.Color});break;case ClientMessageType_SetBackgroundColor:shell.configure({backgroundColor:a.Color});break;case ClientMessageType_CommandCompleted:c=true;shell.stop().disable(true);cancelling=false;powerShellPrompt=a.Prompt;shell.ready();break;case ClientMessageType_Exit:c=true;redirectTo(pages.logout,false);break;case ClientMessageType_SessionTerminated:c=true;shell.targetUnreachable();break;default:shell.write("Not supported:"+a.MessageType)}lastExecutedMessage=a;if(b||c)d=false}if(messagesQueue.length>0)window.setTimeout(ProcessMessages,5);else d&&!loggingOut&&PageMethods._staticInstance.GetClientMessages(sessionKey,OnGetClientMessagesSuccess,StartRecovery,null)}function ProcessPromptForChoiceMessage(a){a.Caption&&shell.write(a.Caption);a.Message&&shell.write(a.Message);showPromptOptions(a);for(var b=0;b<a.Choices.length;b++){if(!a.Choices[b])continue;var e=a.Choices[b].Label,c=e.shortcut(),d=e.replace("&","");if(c)promptShortCuts[c]=b;promptShortCuts[d.toUpperCase()]=b;a.Choices[b].HelpMessage&&promptHelp.push((c||d)+" - "+a.Choices[b].HelpMessage)}promptMessage=a;promptForChoiceHandle=window.setInterval(shell.handlerPromptForChoices,100)}function ProcessReadLineMessage(a){promptMessage=a;promptReadLineHandle=window.setInterval(function(){if(cancelling)CancelPromptTimer(promptReadLineHandle);else if(promptAnswers.length==0&&!shell.input().hasClass("prompt")){shell.input().addClass("readline");shell.prompt();shell.output().attr({scrollTop:shell.output().attr("scrollHeight")})}else if(promptAnswers.length==1){setPromptReplyMessage=function(){PageMethods._staticInstance.SetReadLineReply(sessionKey,promptAnswers[0],OnGetClientMessagesSuccess,StartRecovery,null)};setPromptReplyMessage();promptAnswers=[];window.clearInterval(promptReadLineHandle)}},100)}function ProcessReadLineAsSecureStringMessage(a){promptMessage=a;securePromptHandle=window.setInterval(function(){if(cancelling)CancelPromptTimer(securePromptHandle);else if(promptAnswers.length==0&&!shell.password().isVisible()){shell.secure();shell.output().attr({scrollTop:shell.output().attr("scrollHeight")})}else if(promptAnswers.length==1){setPromptReplyMessage=function(){PageMethods._staticInstance.SetReadLineAsSecureStringReply(sessionKey,promptAnswers[0],OnGetClientMessagesSuccess,StartRecovery,null)};setPromptReplyMessage();promptAnswers=[];window.clearInterval(securePromptHandle)}},100)}function ProcessWriteMessage(a){shell.inline(a.Value,a.ForegroundColor,a.BackgroundColor)}function ProcessWriteLineMessage(a){for(var b=[];;){b=b.concat(a.Value.replace(/\r/g,"").split("\n"));if(b.length>128||messagesQueue.length==0||messagesQueue[0].MessageType!=a.MessageType||messagesQueue[0].ForegroundColor!=a.ForegroundColor||messagesQueue[0].BackgroundColor!=a.BackgroundColor)break;a=messagesQueue.shift()}shell.write(b,a.ForegroundColor,a.BackgroundColor,false,true)}function ProcessWriteProgressMessage(a){toggleProgress(false);shell.writeProgress(a.Record.TimeRemaining,a.Record.Activity,a.Record.StatusDescription,a.Record.CurrentOperation,a.Record.PercentComplete);(a.Record.RecordType==ProgressRecordType_Completed||a.Record.PercentComplete==100)&&toggleProgress(true)}function CancelPromptTimer(a){promptMessage=null;promptAnswers=[];window.clearInterval(a);PageMethods._staticInstance.GetClientMessages(sessionKey,OnGetClientMessagesSuccess,StartRecovery,null)}function state(){var a=iPhone()?"iphone":windowsPhone()?"wp":"web";return a=="web"?a:a+"-"+(verticalOriented()?"vertical":"landscape")}function bootstrap(){if(S("body.console").size()>0){PageMethods.set_timeout(11e4);sessionKey=S("#sessionKey")[0].value;!$browser.msie8&&shell.output().attr("tabindex","1");shell.input().attr("spellcheck",false);clearCurrentTimeout();PageMethods._staticInstance.GetClientConfiguration(sessionKey,OnGetClientConfigurationSucccess,function(){redirectTo(pages.error,false)},null)}}function OnGetClientConfigurationSucccess(a){clientConfiguration=a.Value;shell.configure({title:clientConfiguration.WindowTitle,target:clientConfiguration.ComputerName,windowSize:clientConfiguration.WindowSize,bufferSize:clientConfiguration.BufferSize,foregroundColor:clientConfiguration.ForegroundColor,backgroundColor:clientConfiguration.BackgroundColor,inputForegroundColor:clientConfiguration.InputForegroundColor,inputBackgroundColor:clientConfiguration.InputBackgroundColor,sessionTimeout:clientConfiguration.SessionTimeout*6e4,timeoutCountdown:clientConfiguration.SessionTimeoutWarning*6e4,defaultOptionForegroundColor:"green"});if(a.Value.StartupMessages.length==0)powerShellPrompt=clientConfiguration.Prompt;shell.setup(function(a){cancelling=false;PageMethods._staticInstance.ExecuteCommand(sessionKey,a,OnGetClientMessagesSuccess,StartRecovery,null)},function(){cancelling=true;PageMethods._staticInstance.CancelCommand(sessionKey,OnGetClientMessagesSuccess,StartRecovery,null)});window.onbeforeunload=function(){return L_LeavingApplication_Text};window.onunload=function(){window.onunload.terminateSession&&PageMethods._staticInstance.TerminateSession(sessionKey)};window.onunload.terminateSession=true;if(a.Value.StartupMessages.length>0){for(var b=0;b<a.Value.StartupMessages.length;b++)messagesQueue.push(a.Value.StartupMessages[b]);ProcessMessages()}}String.prototype.shortcut=function(){if(!this)return null;var a=this.match(/&(.)/);return a&&a.length>=2?a[1].toUpperCase():null};sysSelector.prototype.writtenLines=function(){return shell.output().get(0).getElementsByTagName("pre").length};sysSelector.prototype.adjustBuffer=function(c){if(shell.free().size())for(var b=0;b<c;b++){var a=shell.free().children().first();a.size&&a.size()&&a.get(0).tagName.match(/br/i)&&a.remove()}return S(this)};sysSelector.prototype.lineCountWindowSizeWidth=function(){for(var e=S(this),d=clientConfiguration.WindowSize.Width-1,a=(e.val()||e.text()).split("\n"),c=1,b=0;b<a.length;b++)if(a[b].length>=d)c+=Math.floor(a[b].length/d);c+=a.length-1;return c}